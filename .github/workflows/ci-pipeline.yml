name: CI Pipeline - Reddit Cloud Monitor

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Ex√©cute tous les jours √† minuit (tests r√©guliers)
    - cron: '0 0 * * *'

env:
  PYTHON_VERSION: '3.9'
  SPARK_VERSION: '3.5.0'

jobs:
  code-quality:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy
        
    - name: Check code formatting with black
      run: |
        black --check --diff src/ tests/
        
    - name: Check imports ordering with isort
      run: |
        isort --check-only --diff src/ tests/
        
    - name: Lint with flake8
      run: |
        flake8 src/ tests/ --max-line-length=88 --show-source
        
    - name: Type checking with mypy
      run: |
        mypy src/ --ignore-missing-imports

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-xdist
        
    - name: Run unit tests with pytest
      run: |
        python -m pytest tests/ -v --cov=src --cov-report=xml --cov-report=html
        
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests

  data-pipeline-test:
    name: Data Pipeline Test
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pandas numpy pyyaml
        
    - name: Create test directory structure
      run: |
        mkdir -p data/backup
        mkdir -p data/live/raw
        mkdir -p data/live/processed
        
    - name: Generate test dataset
      run: |
        python src/generate_backup.py --test-mode
        
    - name: Test data collector
      run: |
        python src/collector.py --test
        
    - name: Validate generated data
      run: |
        python scripts/validate_data.py
        
    - name: Check data quality
      run: |
        python scripts/data_quality_check.py

  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: data-pipeline-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install full dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyspark==${{ env.SPARK_VERSION }} streamlit plotly
        
    - name: Run end-to-end pipeline
      run: |
        python scripts/run_pipeline.py --test
        
    - name: Test Spark compatibility
      run: |
        python scripts/test_spark_integration.py
        
    - name: Test dashboard generation
      run: |
        python src/dashboard.py --test

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install security tools
      run: |
        pip install bandit safety
        
    - name: Run Bandit security scan
      run: |
        bandit -r src/ -f html -o security-report.html || true
        
    - name: Check for vulnerable dependencies
      run: |
        safety check --json --output safety-report.json || true
        
    - name: Upload security reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          security-report.html
          safety-report.json

  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    needs: integration-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install documentation tools
      run: |
        pip install mkdocs mkdocs-material pymdown-extensions
        
    - name: Build documentation
      run: |
        mkdocs build --site-dir public
        
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public

  performance-test:
    name: Performance Test
    runs-on: ubuntu-latest
    needs: integration-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install performance tools
      run: |
        pip install -r requirements.txt
        pip install memory_profiler psutil
        
    - name: Run performance tests
      run: |
        python scripts/performance_test.py
        
    - name: Upload performance report
      uses: actions/upload-artifact@v3
      with:
        name: performance-report
        path: performance_report.json

  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    needs: [integration-test, security-scan, performance-test]
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Deploy Streamlit app preview
      uses: streamlit/streamlit-cloud-app-action@v0.0.2
      with:
        app_path: src/dashboard.py
        app_name: "reddit-cloud-monitor-pr-${{ github.event.number }}"
        
    - name: Comment PR with preview link
      uses: actions/github-script@v6
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => comment.body.includes('Preview Deployment'));
          
          const commentBody = `## üöÄ Preview Deployment Ready!
          
          **Streamlit Dashboard:** https://reddit-cloud-monitor-pr-${{ github.event.number }}.streamlit.app
          
          **Test Results:** ‚úÖ All checks passed
          
          ---
          *Generated by CI/CD Pipeline*`;
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: commentBody
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
          }

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [integration-test, security-scan, performance-test, build-docs]
    if: success()
    
    steps:
    - name: Send success notification
      run: |
        echo "‚úÖ CI Pipeline completed successfully!"
        echo "Branch: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ci-artifacts
        path: |
          coverage.xml
          security-report.html
          safety-report.json
          performance_report.json

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
    - name: Send failure notification
      run: |
        echo "‚ùå CI Pipeline failed!"
        echo "Branch: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"
        echo "Workflow: ${{ github.workflow }}"
        echo "Job: ${{ github.job }}"
        
    - name: Upload failure logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: failure-logs
        path: |
          ${{ github.workspace }}/**/*.log
          /tmp/*.log